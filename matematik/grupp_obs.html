<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ“˜ Statistik for grupperede data</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; }
    textarea, input, select, button { width: 100%; margin-bottom: 1rem; padding: 0.5rem; }
    .row { display: flex; gap: 2rem; flex-wrap: wrap; }
    .col { flex: 1; min-width: 300px; }
    canvas { background: #fff; border: 1px solid #ddd; margin-bottom: 2rem; }
    table { border-collapse: collapse; width: 100%; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: center; }
    th { background-color: #f3f3f3; }
    h1, h2 { margin-top: 2rem; }
  </style>
</head>
<body>
  <h1>ğŸ“˜ Statistik for grupperede data</h1>

  <div class="row">
    <div class="col">
      <label for="intervals">Intervaller (Ã©t pr. linje, fx 10-20):</label>
      <textarea id="intervals" rows="8"></textarea>
    </div>
    <div class="col">
      <label for="frequencies">Hyppigheder (Ã©t pr. linje, fx 4):</label>
      <textarea id="frequencies" rows="8"></textarea>
    </div>
  </div>

  <button onclick="processData()">ğŸš€ Beregn og vis data</button>

  <div id="exportButtons" style="display:none; margin-top: 1rem;">
    <button onclick="downloadCSV()">â¬‡ï¸ Download CSV</button>
    <button onclick="downloadPDF()">ğŸ§¾ Download PDF</button>
    <button onclick="downloadPlot('sumkurveCanvas', 'sumkurve.png')">â¬‡ï¸ Download Sumkurve</button>
    <button onclick="downloadPlot('histogramCanvas', 'histogram.png')">â¬‡ï¸ Download Histogram</button>
  </div>

  <div id="results"></div>

  <h2>ğŸ“ Fraktilberegning</h2>
  <div class="row">
    <div class="col">
      <label for="fraktilInput">Fraktil p (fx 0.25):</label>
      <input type="number" id="fraktilInput" step="0.01" min="0" max="1" />
    </div>
    <div class="col">
      <label for="xInput">VÃ¦rdi x (for at finde p):</label>
      <input type="number" id="xInput" step="0.1" />
    </div>
  </div>
  <button onclick="beregnFraktil()">ğŸ“ Beregn fraktil</button>
  <div id="fraktilResultat"></div>

  <h2>ğŸ“ˆ Sumkurve</h2>
  <canvas id="sumkurveCanvas" width="800" height="400"></canvas>

  <h2>ğŸ“Š Histogram</h2>
  <canvas id="histogramCanvas" width="800" height="400"></canvas>

  <script>
    let globalData = {};
    let sumChart, histogramChart;

    function processData() {
      const intervals = document.getElementById("intervals").value.trim().split("\n").map(line => {
        const [a, b] = line.split("-").map(Number);
        return [a, b];
      });
      const frequencies = document.getElementById("frequencies").value.trim().split("\n").map(Number);
      if (intervals.length !== frequencies.length) {
        alert("Antallet af intervaller og hyppigheder skal vÃ¦re det samme.");
        return;
      }

      const N = frequencies.reduce((a, b) => a + b, 0);
      const midpoints = intervals.map(([a, b]) => (a + b) / 2);
      const mean = frequencies.reduce((sum, f, i) => sum + f * midpoints[i], 0) / N;
      const varPop = frequencies.reduce((sum, f, i) => sum + f * (midpoints[i] - mean) ** 2, 0) / N;
      const stdPop = Math.sqrt(varPop);
      const varSample = N > 1 ? frequencies.reduce((sum, f, i) => sum + f * (midpoints[i] - mean) ** 2, 0) / (N - 1) : NaN;
      const stdSample = Math.sqrt(varSample);
      const cumFreq = []; let sum = 0;
      for (let f of frequencies) { sum += f; cumFreq.push(sum); }

      const rows = intervals.map((interval, i) => {
        return `
          <tr>
            <td>${interval[0]}â€“${interval[1]}</td>
            <td>${frequencies[i]}</td>
            <td>${midpoints[i].toFixed(2)}</td>
            <td>${cumFreq[i]}</td>
            <td>${(cumFreq[i] / N * 100).toFixed(2)}%</td>
          </tr>`;
      });

      document.getElementById("results").innerHTML = `
        <div id="exportContent">
          <h2>ğŸ“Š Oversigt over data</h2>
          <table>
            <tr><th>Interval</th><th>Hyppighed</th><th>Midtpunkt</th><th>Kum. hyppighed</th><th>Kum. frekvens (%)</th></tr>
            ${rows.join("")}
          </table>
          <h2>ğŸ“‹ Statistik</h2>
          <table>
            <tr><th>Parameter</th><th>VÃ¦rdi</th></tr>
            <tr><td>n</td><td>${N}</td></tr>
            <tr><td>MiddelvÃ¦rdi</td><td>${mean.toFixed(2)}</td></tr>
            <tr><td>Populationsvarians</td><td>${varPop.toFixed(2)}</td></tr>
            <tr><td>Populationsspredning</td><td>${stdPop.toFixed(2)}</td></tr>
            <tr><td>StikprÃ¸vevarians</td><td>${varSample.toFixed(2)}</td></tr>
            <tr><td>StikprÃ¸vespredning</td><td>${stdSample.toFixed(2)}</td></tr>
          </table>
        </div>`;

      document.getElementById("exportButtons").style.display = "block";
      globalData = { intervals, frequencies, N, cumFreq, midpoints };
      showSumkurve();
      showHistogram();
    }

    function showSumkurve() {
      const { intervals, cumFreq } = globalData;
      const xVals = [intervals[0][0], ...intervals.map(i => i[1])];
      const yVals = [0, ...cumFreq];

      const ctx = document.getElementById("sumkurveCanvas").getContext("2d");
      if (sumChart) sumChart.destroy();
      sumChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: xVals,
          datasets: [{
            label: "Kumulativ hyppighed",
            data: yVals,
            borderColor: "orange",
            backgroundColor: "transparent",
            tension: 0,
            fill: false,
            pointRadius: 0,
            pointHoverRadius: 0
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true, title: { display: true, text: "Kumulativ hyppighed" } },
            x: { title: { display: true, text: "IntervalgrÃ¦nse" } }
          }
        }
      });
    }

    function showHistogram() {
      const { intervals, frequencies } = globalData;
      const labels = intervals.map(([a, b]) => `${a}â€“${b}`);
      const ctx = document.getElementById("histogramCanvas").getContext("2d");
      if (histogramChart) histogramChart.destroy();
      histogramChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "Hyppighed",
            data: frequencies,
            backgroundColor: "rgba(100,149,237,0.7)",
            borderColor: "rgba(100,149,237,1)",
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true, title: { display: true, text: "Hyppighed" } },
            x: { title: { display: true, text: "Interval" } }
          }
        }
      });
    }

    function beregnFraktil() {
      const { intervals, frequencies, N, cumFreq } = globalData;
      const p = parseFloat(document.getElementById("fraktilInput").value);
      const x = parseFloat(document.getElementById("xInput").value);
      let output = "";

      if (!isNaN(p) && p > 0 && p < 1) {
        const target = p * N;
        for (let i = 0; i < frequencies.length; i++) {
          if (cumFreq[i] >= target) {
            const [a, b] = intervals[i];
            const F = cumFreq[i - 1] || 0;
            const f_i = frequencies[i];
            const h = b - a;
            const fraktilvÃ¦rdi = a + ((target - F) / f_i) * h;
            output += `<p>ğŸ¯ FraktilvÃ¦rdi for p=${p} er <strong>${fraktilvÃ¦rdi.toFixed(2)}</strong></p>`;
            break;
          }
        }
      }

      if (!isNaN(x)) {
        for (let i = 0; i < intervals.length; i++) {
          const [a, b] = intervals[i];
          if (x <= b) {
            const F = cumFreq[i - 1] || 0;
            const f_i = frequencies[i];
            const h = b - a;
            const p_beregnet = (F + f_i * (x - a) / h) / N;
            output += `<p>ğŸ“ Fraktil p for x=${x} er <strong>${p_beregnet.toFixed(2)}</strong></p>`;
            break;
          }
        }
      }

      document.getElementById("fraktilResultat").innerHTML = output;
    }

    function downloadCSV() {
      const { intervals, frequencies, midpoints, cumFreq, N } = globalData;
      let csv = "Interval,Hyppighed,Midtpunkt,Kumulativ,Kum. frekvens (%)\n";
      for (let i = 0; i < intervals.length; i++) {
        const [a, b] = intervals[i];
        csv += `${a}-${b},${frequencies[i]},${midpoints[i].toFixed(2)},${cumFreq[i]},${(cumFreq[i]/N*100).toFixed(2)}%\n`;
      }
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "statistik_data.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    function downloadPDF() {
      const element = document.getElementById("exportContent");
      html2pdf().set({
        margin: 0.5,
        filename: 'statistik_data.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
      }).from(element).save();
    }

    // Ny funktion til download af canvas som billede med hvid baggrund
    function downloadPlot(canvasId, filename) {
      const originalCanvas = document.getElementById(canvasId);
      if (!originalCanvas) {
        alert("Canvas ikke fundet!");
        return;
      }

      // Lav et nyt canvas med samme dimensioner
      const canvas = document.createElement("canvas");
      canvas.width = originalCanvas.width;
      canvas.height = originalCanvas.height;
      const ctx = canvas.getContext("2d");

      // Tegn hvid baggrund
      ctx.fillStyle = "white";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Tegn det originale canvas ovenpÃ¥
      ctx.drawImage(originalCanvas, 0, 0);

      // Gem som blob med hvid baggrund
      canvas.toBlob(function(blob) {
        const link = document.createElement("a");
        link.download = filename;
        link.href = URL.createObjectURL(blob);
        link.click();
        URL.revokeObjectURL(link.href);
      }, "image/png");
    }
  </script>
</body>
</html>
