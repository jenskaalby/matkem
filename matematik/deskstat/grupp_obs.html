<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sumkurve med kumulativ frekvens + histogram</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      max-width: 900px;
    }
    .input-row {
      display: flex;
      gap: 10px;
      margin-bottom: 1em;
    }
    textarea {
      flex: 1;
      height: 100px;
      font-size: 14px;
      resize: vertical;
    }
    input[type="number"] {
      width: 80px;
    }
    .flex-row {
      display: flex;
      gap: 15px;
      margin-bottom: 1em;
      flex-wrap: wrap;
      align-items: center;
    }
    label {
      margin-right: 5px;
    }
    button {
      padding: 6px 12px;
      font-size: 14px;
      cursor: pointer;
    }
    #sumkurveCanvas, #histogramCanvas {
      max-width: 100%;
      height: 300px;
      margin-top: 30px;
      margin-bottom: 30px;
    }
    #fraktilResultat {
      font-weight: bold;
      margin-top: 1em;
    }
  </style>
</head>
<body>
  <h1>Sumkurve med kumulativ frekvens + histogram</h1>

  <p>Indtast intervaller (f.eks. 0-10) og hyppigheder, én pr. linje:</p>

  <div class="input-row">
    <textarea id="intervals" placeholder="fx&#10;0-10&#10;10-20&#10;20-30"></textarea>
    <textarea id="frequencies" placeholder="fx&#10;5&#10;12&#10;8"></textarea>
  </div>

  <button onclick="processData()">Beregn og vis sumkurve + histogram</button>

  <!-- Sumkurve øverst -->
  <canvas id="sumkurveCanvas"></canvas>

  <!-- Fraktil beregning felter under sumkurven -->
  <div class="flex-row">
    <div>
      <label for="fraktilInput1">p-fraktil (0–1):</label>
      <input id="fraktilInput1" type="number" step="0.01" min="0" max="1" />
    </div>
    <div>
      <label for="fraktilInput2">p-fraktil (0–1):</label>
      <input id="fraktilInput2" type="number" step="0.01" min="0" max="1" />
    </div>
    <div>
      <label for="fraktilInput3">p-fraktil (0–1):</label>
      <input id="fraktilInput3" type="number" step="0.01" min="0" max="1" />
    </div>
  </div>
  <div class="flex-row">
    <div>
      <label for="xInput1">x-værdi:</label>
      <input id="xInput1" type="number" step="any" />
    </div>
    <div>
      <label for="xInput2">x-værdi:</label>
      <input id="xInput2" type="number" step="any" />
    </div>
    <div>
      <label for="xInput3">x-værdi:</label>
      <input id="xInput3" type="number" step="any" />
    </div>
  </div>

  <button onclick="beregnFraktiler()">Beregn fraktiler / p-værdier</button>

  <div id="fraktilResultat"></div>

  <!-- Histogram nederst -->
  <canvas id="histogramCanvas"></canvas>

<script>
let globalData = {};
let sumChart;
let histogramChart;

function processData() {
  const intervalsRaw = document.getElementById("intervals").value.trim();
  const frequenciesRaw = document.getElementById("frequencies").value.trim();
  if (!intervalsRaw || !frequenciesRaw) {
    alert("Indtast venligst både intervaller og hyppigheder.");
    return;
  }
  const intervals = intervalsRaw.split("\n").map(line => {
    const parts = line.trim().split("-");
    if (parts.length !== 2) {
      alert("Intervaller skal være på formatet a-b");
      throw new Error("Forkert interval format");
    }
    return [Number(parts[0]), Number(parts[1])];
  });
  const frequencies = frequenciesRaw.split("\n").map(x => Number(x.trim()));

  if (intervals.length !== frequencies.length) {
    alert("Antallet af intervaller og hyppigheder skal være det samme.");
    return;
  }

  const N = frequencies.reduce((a, b) => a + b, 0);
  if (N === 0) {
    alert("Samlet hyppighed må ikke være nul.");
    return;
  }
  const midpoints = intervals.map(([a, b]) => (a + b) / 2);

  const cumFreq = [];
  let sum = 0;
  for (let f of frequencies) {
    sum += f;
    cumFreq.push(sum);
  }

  globalData = { intervals, frequencies, N, cumFreq, midpoints };

  showSumkurve();
  showHistogram();
  document.getElementById("fraktilResultat").innerHTML = "";
}

function interpolateXforP(p) {
  const { intervals, frequencies, N, cumFreq } = globalData;
  if (!intervals) return null;
  const target = p * N;
  for (let i = 0; i < frequencies.length; i++) {
    if (cumFreq[i] >= target) {
      const [a, b] = intervals[i];
      const F = i > 0 ? cumFreq[i - 1] : 0;
      const f_i = frequencies[i];
      const h = b - a;
      const xVal = a + ((target - F) / f_i) * h;
      return xVal;
    }
  }
  return null;
}

function interpolatePforX(x) {
  const { intervals, frequencies, N, cumFreq } = globalData;
  if (!intervals) return null;
  for (let i = 0; i < intervals.length; i++) {
    const [a, b] = intervals[i];
    if (x <= b) {
      const F = i > 0 ? cumFreq[i - 1] : 0;
      const f_i = frequencies[i];
      const h = b - a;
      const pVal = (F + f_i * (x - a) / h) / N;
      return pVal;
    }
  }
  return 1;
}

function showSumkurve() {
  const { intervals, cumFreq, N } = globalData;
  if (!intervals) return;
  const points = [{ x: intervals[0][0], y: 0 }];
  for (let i = 0; i < intervals.length; i++) {
    points.push({ x: intervals[i][1], y: cumFreq[i] / N });
  }

  const ctx = document.getElementById("sumkurveCanvas").getContext("2d");
  if (sumChart) sumChart.destroy();

  sumChart = new Chart(ctx, {
    type: "line",
    data: {
      datasets: [{
        label: "Kumulativ frekvens",
        data: points,
        borderColor: "orange",
        backgroundColor: "transparent",
        tension: 0,
        fill: false,
        pointRadius: 3,
        pointHoverRadius: 5,
        showLine: true,
      }]
    },
    options: {
      responsive: true,
      scales: {
        x: {
          type: "linear",
          title: { display: true, text: "Intervalgrænse" },
          min: intervals[0][0],
          max: intervals[intervals.length - 1][1],
          ticks: { stepSize: 1 }
        },
        y: {
          beginAtZero: true,
          max: 1,
          title: { display: true, text: "Kumulativ frekvens" }
        }
      },
      plugins: {
        legend: { display: false }
      },
      animation: false,
    }
  });
}

function showHistogram() {
  const { intervals, frequencies, N } = globalData;
  if (!intervals) return;
  const ctx = document.getElementById("histogramCanvas").getContext("2d");
  if (histogramChart) histogramChart.destroy();

  const labels = intervals.map(interval => `${interval[0]}–${interval[1]}`);
  const frekvenser = frequencies.map(f => f / N);

  histogramChart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: labels,
      datasets: [{
        label: "Frekvens",
        data: frekvenser,
        backgroundColor: "rgba(0, 123, 255, 0.7)",
        borderColor: "rgba(0, 123, 255, 1)",
        borderWidth: 1,
        barPercentage: 1.0,
        categoryPercentage: 1.0,
      }]
    },
    options: {
      responsive: true,
      scales: {
        x: {
          title: { display: true, text: "Interval" },
          grid: { display: false }
        },
        y: {
          beginAtZero: true,
          max: 1,
          title: { display: true, text: "Frekvens" },
          ticks: { precision: 2 }
        }
      },
      plugins: {
        legend: { display: true }
      },
      animation: false,
    }
  });
}

function beregnFraktiler() {
  if (!globalData.intervals) {
    alert("Indtast og beregn først data.");
    return;
  }

  const pInputs = [
    Number(document.getElementById("fraktilInput1").value),
    Number(document.getElementById("fraktilInput2").value),
    Number(document.getElementById("fraktilInput3").value),
  ].filter(v => !isNaN(v) && v >= 0 && v <= 1);

  const xInputs = [
    Number(document.getElementById("xInput1").value),
    Number(document.getElementById("xInput2").value),
    Number(document.getElementById("xInput3").value),
  ].filter(v => !isNaN(v));

  // Beregn x for p
  const pPoints = pInputs.map(p => {
    const xVal = interpolateXforP(p);
    return { p, x: xVal };
  });

  // Beregn p for x
  const xPoints = xInputs.map(xVal => {
    const pVal = interpolatePforX(xVal);
    return { x: xVal, y: pVal, pVal };
  });

  // Opdater sumkurven med lodrette/vandrette stiplede linjer
  const { intervals, cumFreq, N } = globalData;
  const points = [{ x: intervals[0][0], y: 0 }];
  for (let i = 0; i < intervals.length; i++) {
    points.push({ x: intervals[i][1], y: cumFreq[i] / N });
  }

  const extraDatasets = [];

  pPoints.forEach(pt => {
    if (pt.x === null) return;
    // lodret stiplet linje (rød)
    extraDatasets.push({
      label: `p=${pt.p.toFixed(2)} (lodret)`,
      data: [
        { x: pt.x, y: 0 },
        { x: pt.x, y: interpolatePforX(pt.x) }
      ],
      borderColor: "red",
      borderWidth: 1,
      borderDash: [5, 5],
      fill: false,
      showLine: true,
      pointRadius: 0,
      tension: 0,
    });
    // vandret stiplet linje (rød)
    extraDatasets.push({
      label: `p=${pt.p.toFixed(2)} (vandret)`,
      data: [
        { x: intervals[0][0], y: interpolatePforX(pt.x) },
        { x: pt.x, y: interpolatePforX(pt.x) }
      ],
      borderColor: "red",
      borderWidth: 1,
      borderDash: [5, 5],
      fill: false,
      showLine: true,
      pointRadius: 0,
      tension: 0,
    });
  });

  xPoints.forEach(pt => {
    if (pt.y === null) return;
    // lodret stiplet linje (grøn)
    extraDatasets.push({
      label: `x=${pt.x.toFixed(2)} (lodret)`,
      data: [
        { x: pt.x, y: 0 },
        { x: pt.x, y: pt.y }
      ],
      borderColor: "green",
      borderWidth: 1,
      borderDash: [5, 5],
      fill: false,
      showLine: true,
      pointRadius: 0,
      tension: 0,
    });
    // vandret stiplet linje (grøn)
    extraDatasets.push({
      label: `x=${pt.x.toFixed(2)} (vandret)`,
      data: [
        { x: intervals[0][0], y: pt.y },
        { x: pt.x, y: pt.y }
      ],
      borderColor: "green",
      borderWidth: 1,
      borderDash: [5, 5],
      fill: false,
      showLine: true,
      pointRadius: 0,
      tension: 0,
    });
  });

  const ctx = document.getElementById("sumkurveCanvas").getContext("2d");
  if (sumChart) sumChart.destroy();

  const mainDataset = {
    label: "Kumulativ frekvens",
    data: points,
    borderColor: "orange",
    backgroundColor: "transparent",
    tension: 0,
    fill: false,
    pointRadius: 3,
    pointHoverRadius: 5,
    showLine: true,
  };

  sumChart = new Chart(ctx, {
    type: "line",
    data: {
      datasets: [mainDataset, ...extraDatasets]
    },
    options: {
      responsive: true,
      scales: {
        x: {
          type: "linear",
          title: { display: true, text: "Intervalgrænse" },
          min: intervals[0][0],
          max: intervals[intervals.length - 1][1],
          ticks: { stepSize: 1 }
        },
        y: {
          beginAtZero: true,
          max: 1,
          title: { display: true, text: "Kumulativ frekvens" }
        }
      },
      plugins: {
        legend: { display: false }
      },
      animation: false,
    }
  });

  // Vis resultattekst med fraktiler og p-værdier
  const fraktilTekst = pPoints.map(pt => {
    if (pt.x === null) return `p = ${pt.p.toFixed(2)} → x: kan ikke beregnes`;
    return `p = ${pt.p.toFixed(2)} → x ≈ ${pt.x.toFixed(2)}`;
  }).join("<br>");
  const pTekst = xPoints.map(pt => {
    if (pt.y === null) return `x = ${pt.x.toFixed(2)} → p: kan ikke beregnes`;
    return `x = ${pt.x.toFixed(2)} → p ≈ ${pt.y.toFixed(3)}`;
  }).join("<br>");

  document.getElementById("fraktilResultat").innerHTML =
    `<div><b>Fraktiler:</b><br>${fraktilTekst}<br><b>p-værdier:</b><br>${pTekst}</div>`;
}
</script>

</body>
</html>
